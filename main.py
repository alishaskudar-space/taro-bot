import asyncio
import random
import os
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import FSInputFile, KeyboardButton, ReplyKeyboardMarkup

API_TOKEN = os.getenv("BOT_TOKEN")
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

CARDS_FOLDER = "cards"

MEANINGS = {
    "00": {
        "up": "–î—É—Ä–∞–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–≤–µ—Ä—å –≤ –Ω–æ–≤—É—é –≥–ª–∞–≤—É —Ç–≤–æ–µ–π —Å—É–¥—å–±—ã, –ø–æ–ª–Ω—É—é –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ –∏ —Å–≤–µ–∂–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –≠—Ç–æ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –í—Å–µ–ª–µ–Ω–Ω–∞—è –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç —Ç–µ–±—è —à–∞–≥–Ω—É—Ç—å –≤ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ—Å—Ç—å —Å –æ—Ç–∫—Ä—ã—Ç—ã–º —Å–µ—Ä–¥—Ü–µ–º –∏ –¥–µ—Ç—Å–∫–æ–π –≤–µ—Ä–æ–π, –æ—Å—Ç–∞–≤–∏–≤ –ø–æ–∑–∞–¥–∏ —Å—Ç–∞—Ä—ã–µ –æ–∫–æ–≤—ã –∏ —Å—Ç—Ä–∞—Ö–∏. –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∂–¥—É—Ç, –∏ –∫–∞–∂–¥—ã–π —à–∞–≥ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —Ä–æ—Å—Ç—É, –µ—Å–ª–∏ —Ç—ã –ø–æ–∑–≤–æ–ª–∏—à—å —Å–µ–±–µ –±—ã—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–º –æ—Ç –ø—Ä–µ–¥—É–±–µ–∂–¥–µ–Ω–∏–π –∏ –æ–∂–∏–¥–∞–Ω–∏–π. –î–æ–≤–µ—Ä—å—Å—è –ø–æ—Ç–æ–∫—É –∂–∏–∑–Ω–∏ ‚Äî –æ–Ω –Ω–µ—Å—ë—Ç —Ç–µ–±—è –∫ —á–µ–º—É-—Ç–æ –≤–µ–ª–∏–∫–æ–º—É.",
        "rev": "–¢—ã —Å—Ç–æ–∏—à—å —É –æ–±—Ä—ã–≤–∞ –∏ –±–æ–∏—à—å—Å—è —Å–¥–µ–ª–∞—Ç—å —à–∞–≥, –ø–∞—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å—Ç—Ä–∞—Ö–æ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∏ —Ä–∏—Å–∫–æ–º –Ω–µ—É–¥–∞—á–∏. –ë–µ–∑—Ä–∞—Å—Å—É–¥—Å—Ç–≤–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º, –Ω–æ —ç—Ç–æ —Ç–∞–∫–∂–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø—Ä—ã–∂–∫–æ–º –≤ –ø—É—Å—Ç–æ—Ç—É. –£–ø—É—â–µ–Ω–Ω—ã–µ —à–∞–Ω—Å—ã —Ç–∞—è—Ç –≤ —Å–µ–±–µ —É—Ä–æ–∫–∏, –Ω–æ —Å–µ–π—á–∞—Å –≤—Ä–µ–º—è —Å–æ–±—Ä–∞—Ç—å—Å—è –∏ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏—Ç—å —Å–≤–æ–π –ø—É—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–∞–¥–µ–Ω–∏—è. –û—Å–≤–æ–±–æ–¥–∏—Å—å –æ—Ç –∏–ª–ª—é–∑–∏–π –∏ –Ω–∞–π–¥–∏ –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–º–µ–ª–æ—Å—Ç—å—é –∏ –º—É–¥—Ä–æ—Å—Ç—å—é."
    },
    "01": {
        "up": "–ú–∞–≥ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –∏ –≥–æ–≤–æ—Ä–∏—Ç: ¬´–í—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ ‚Äî —É–∂–µ –≤ —Ç–≤–æ–∏—Ö —Ä—É–∫–∞—Ö¬ª, –Ω–∞–ø–æ–º–∏–Ω–∞—è –æ —Ç–≤–æ–µ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–∏–ª–µ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∂–µ–ª–∞–Ω–∏—è —á–µ—Ä–µ–∑ –≤–æ–ª—é –∏ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ. –¢—ã –æ–±–ª–∞–¥–∞–µ—à—å –≤—Å–µ–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ ‚Äî –∑–µ–º–ª—ë–π, –≤–æ–¥–æ–π, –≤–æ–∑–¥—É—Ö–æ–º –∏ –æ–≥–Ω—ë–º ‚Äî —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –∂–µ–ª–∞–µ—à—å, —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–≤—à–∏—Å—å –Ω–∞ —Ü–µ–ª–∏. –≠—Ç–æ –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏–π, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≥–¥–µ –∫–∞–∂–¥—ã–π –∂–µ—Å—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ–º —É—Å–ø–µ—Ö–∞. –í–µ—Ä—å –≤ —Å–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏ –Ω–∞–ø—Ä–∞–≤—å —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ —Ç–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–æ.",
        "rev": "–¢—ã –¥–µ—Ä–∂–∏—à—å –≤ —Ä—É–∫–∞—Ö –≤–æ–ª—à–µ–±–Ω—É—é –ø–∞–ª–æ—á–∫—É, –Ω–æ –∑–∞–±—ã–ª –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ, –ø–æ–∑–≤–æ–ª—è—è –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∏–ª–∏ –≤–Ω–µ—à–Ω–∏–º —Å–∏–ª–∞–º —Ä–∞—Å—Å–µ–∏–≤–∞—Ç—å —Ç–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª. –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∑–∞—Å—Ç–æ—é, –æ–±–º–∞–Ω—É –∏–ª–∏ –∏–ª–ª—é–∑–∏—è–º, –≥–¥–µ —Å–∏–ª–∞ —É—Ö–æ–¥–∏—Ç –≤ –ø—É—Å—Ç–æ—Ç—É. –°–µ–π—á–∞—Å –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏—Ç—å —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã, –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è –∏ –≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é. –°–æ–±–µ—Ä–∏—Å—å –∏ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è, —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ö–∞–æ—Å –≤ –≥–∞—Ä–º–æ–Ω–∏—é."
    },
    "02": {
        "up": "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞ –ø—Ä–∏–ø–æ–¥–Ω–∏–º–∞–µ—Ç –∑–∞–≤–µ—Å—É, —Ä–∞—Å–∫—Ä—ã–≤–∞—è —Ç–∞–π–Ω—ã –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è –∏ –ø—Ä–∏–≥–ª–∞—à–∞—è –¥–æ–≤–µ—Ä–∏—Ç—å—Å—è –∏–Ω—Ç—É–∏—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —à–µ–ø—á–µ—Ç –æ—Ç–≤–µ—Ç—ã –∏–∑ –≥–ª—É–±–∏–Ω –¥—É—à–∏. –≠—Ç–æ –∫–∞—Ä—Ç–∞ –∑–∞–≥–∞–¥–æ–∫, –∂–µ–Ω—Å–∫–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å–∫—Ä—ã—Ç–æ–≥–æ –∑–Ω–∞–Ω–∏—è, –≥–¥–µ –º–æ–ª—á–∞–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç –≥—Ä–æ–º—á–µ —Å–ª–æ–≤, –∞ —Å–Ω—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞–º–∏. –°–ª—É—à–∞–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å, –º–µ–¥–∏—Ç–∏—Ä—É–π –∏ –ø–æ–∑–≤–æ–ª—è–π —Ç–∞–π–Ω–∞–º —Ä–∞—Å–∫—Ä—ã—Ç—å—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –±–µ–∑ —É—Å–∏–ª–∏–π. –í—Ä–µ–º—è –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π –∏ –¥—É—Ö–æ–≤–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞, –≥–¥–µ –≤—Å—ë –≤–∏–¥–∏–º–æ–µ ‚Äî –ª–∏—à—å –∏–ª–ª—é–∑–∏—è.",
        "rev": "–¢—ã –∑–∞–∫—Ä—ã–≤–∞–µ—à—å –≥–ª–∞–∑–∞ –Ω–∞ —Ç–æ, —á—Ç–æ —É–∂–µ –¥–∞–≤–Ω–æ –≤–∏–¥–∏—à—å, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∏–Ω—Ç—É–∏—Ü–∏—é –∏ –ø–æ–∑–≤–æ–ª—è—è —Å–µ–∫—Ä–µ—Ç–∞–º –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –≤ —Ç–µ–Ω–∏. –°–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã –∏–ª–∏ –æ–±–º–∞–Ω –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—É, –≥–¥–µ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ –∫—Ä–∏—á–∏—Ç, –Ω–æ —Ç—ã –Ω–µ —Å–ª—ã—à–∏—à—å. –°–µ–π—á–∞—Å –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞, —Å—Ç–æ–ª–∫–Ω—É—Ç—å—Å—è —Å –ø—Ä–∞–≤–¥–æ–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º '—è'. –û—Å–≤–æ–±–æ–¥–∏—Å—å –æ—Ç –∏–ª–ª—é–∑–∏–π –∏ –ø–æ–∑–≤–æ–ª—å —Å–≤–µ—Ç—É –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç—å –≤ —Ç–µ–º–Ω–æ—Ç—É."
    }
}

NAMES = {"00": "0. –î—É—Ä–∞–∫", "01": "I. –ú–∞–≥", "02": "II. –í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞"}

def get_main_menu():
    return ReplyKeyboardMarkup(resize_keyboard=True, keyboard=[
        [KeyboardButton(text="üîÆ –û–¥–Ω–∞ –∫–∞—Ä—Ç–∞ ‚Äî —Å–æ–≤–µ—Ç —Å—É–¥—å–±—ã")],
        [KeyboardButton(text="üÉè –¢—Ä–∏ –∫–∞—Ä—Ç—ã ‚Äî –ø—É—Ç—å –¥—É—à–∏")],
        [KeyboardButton(text="‚ú® –ö–µ–ª—å—Ç—Å–∫–∏–π –∫—Ä–µ—Å—Ç ‚Äî –ø–æ–ª–Ω–æ–µ –≥–∞–¥–∞–Ω–∏–µ")],
        [KeyboardButton(text="‚ùì –î–∞ / –ù–µ—Ç ‚Äî –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç")]
    ])

@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer(
        "‚ú® –ó–≤—ë–∑–¥—ã –≤—ã—Å—Ç—Ä–æ–∏–ª–∏—Å—å –¥–ª—è —Ç–µ–±—è –≤ —ç—Ç–æ—Ç –º–∏–≥‚Ä¶ ‚ú®\n\n"
        "–Ø ‚Äî –°–≤–µ—Ç–ª–∞–Ω–∞. –¢–≤–æ—è –ø—Ä–æ–≤–∏–¥–∏—Ü–∞. üîÆ\n"
        "–í—ã–±–µ—Ä–∏ —Ä–∏—Ç—É–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ—Ä–¥—Ü–µ–º: ‚ù§Ô∏è",
        reply_markup=get_main_menu()
    )

async def ritual_delay(message: types.Message):
    await message.answer("–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ —Å–≤–æ—ë–º –≤–æ–ø—Ä–æ—Å–µ‚Ä¶\n"
                         "–î—ã—à–∏ –≥–ª—É–±–æ–∫–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–∞–∫ —ç–Ω–µ—Ä–≥–∏—è —Ç–µ—á—ë—Ç —á–µ—Ä–µ–∑ —Ç–µ–±—è‚Ä¶\n"
                         "–í—Å–µ–ª–µ–Ω–Ω–∞—è —Å–ª—É—à–∞–µ—Ç. –ê—Ä–∫–∞–Ω—ã –ø—Ä–æ–±—É–∂–¥–∞—é—Ç—Å—è‚Ä¶\n"
                         "–ö–æ–ª–æ–¥–∞ —Ç–∞—Å—É–µ—Ç—Å—è –≤ —Ç–µ–º–Ω–æ—Ç–µ‚Ä¶ ‚ú®")
    await asyncio.sleep(3)  # 3 —Å–µ–∫—É–Ω–¥—ã –º–∞–≥–∏–∏

def get_random_card():
    code = random.choice(["00", "01", "02"])
    orient = random.choice(["up", "rev"])
    path = os.path.join(CARDS_FOLDER, f"{code}_{orient}.jpg")
    return code, orient, path

@dp.message(F.text == "üîÆ –û–¥–Ω–∞ –∫–∞—Ä—Ç–∞ ‚Äî —Å–æ–≤–µ—Ç —Å—É–¥—å–±—ã")
async def one_card(message: types.Message):
    await ritual_delay(message)
    code, orient, path = get_random_card()
    emoji = "‚ú®" if orient == "up" else "üåô"
    caption = f"{emoji} *{NAMES[code]}* { '(–ø—Ä—è–º–æ–µ)' if orient=='up' else '(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–µ)' }\n\n"
    caption += f"{MEANINGS[code][orient]}\n\n"
    caption += f"–î—ã—à–∏. –û—Ç–≤–µ—Ç —É–∂–µ —Ç–µ—á—ë—Ç –∫ —Ç–µ–±–µ."
    
    if os.path.exists(path):
        await message.answer_photo(FSInputFile(path), caption=caption, parse_mode="Markdown")
    else:
        await message.answer(caption, parse_mode="Markdown")

@dp.message(F.text == "üÉè –¢—Ä–∏ –∫–∞—Ä—Ç—ã ‚Äî –ø—É—Ç—å –¥—É—à–∏")
async def three_cards(message: types.Message):
    await ritual_delay(message)
    cards = [get_random_card() for _ in range(3)]
    media = []
    text = "*–¢—Ä–∏ –∫–∞—Ä—Ç—ã ‚Äî –ø—É—Ç—å –¥—É—à–∏*\n\n"
    positions = ["üï∞ –ü—Ä–æ—à–ª–æ–µ", "üåü –ù–∞—Å—Ç–æ—è—â–µ–µ", "üîÆ –ë—É–¥—É—â–µ–µ"]
    
    for i, (code, orient, path) in enumerate(cards):
        emoji = "‚ú®" if orient == "up" else "üåô"
        text += f"{positions[i]}\n{emoji} *{NAMES[code]}* { '(–ø—Ä—è–º–æ–µ)' if orient=='up' else '(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–µ)' }\n"
        text += f"{MEANINGS[code][orient]}\n\n"
        if os.path.exists(path):
            media.append(types.InputMediaPhoto(media=FSInputFile(path)))
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞ –±–µ–∑ caption
    if media:
        await message.answer_media_group(media)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    await message.answer(text + "–¢—Ä–∏ –Ω–∏—Ç–∏ —Å–ø–ª–µ–ª–∏—Å—å. –°—É–¥—å–±–∞ —É–∂–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å.", parse_mode="Markdown")

@dp.message(F.text == "‚ú® –ö–µ–ª—å—Ç—Å–∫–∏–π –∫—Ä–µ—Å—Ç ‚Äî –ø–æ–ª–Ω–æ–µ –≥–∞–¥–∞–Ω–∏–µ")
async def celtic_cross(message: types.Message):
    await ritual_delay(message)
    # –ü–æ–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏–º 10 –∫–∞—Ä—Ç
    await message.answer("*–ö–µ–ª—å—Ç—Å–∫–∏–π –∫—Ä–µ—Å—Ç*\n\n–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ–µ –≥–∞–¥–∞–Ω–∏–µ –Ω–∞ 10 –∫–∞—Ä—Ç. –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ—á—É–≤—Å—Ç–≤—É–π —ç–Ω–µ—Ä–≥–∏—é.")

@dp.message(F.text == "‚ùì –î–∞ / –ù–µ—Ç ‚Äî –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç")
async def yes_no(message: types.Message):
    await ritual_delay(message)
    answers = ["‚úÖ –î–∞, –∑–≤—ë–∑–¥—ã –≥–æ–≤–æ—Ä—è—Ç —è—Å–Ω–æ.", "‚ùå –ù–µ—Ç, –ø—É—Ç—å –∑–∞–∫—Ä—ã—Ç.", "‚ùì –í–æ–∑–º–æ–∂–Ω–æ, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏—à—å –∫—É—Ä—Å."]
    await message.answer(random.choice(answers))

async def main():
    print("–°–≤–µ—Ç–ª–∞–Ω–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∏—Ç—É–∞–ª—É‚Ä¶")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())